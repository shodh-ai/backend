name: Deploy Application

on:
  push:
    branches:
      - main

env:
  BUILD_NUMBER: ${{ github.run_number }}

jobs:

  get-environment:
    name: Get Environment
    runs-on: ubuntu-22.04
    outputs:
      environment-name: ${{ steps.environment-name.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get Branch Name
        run: |
          BRANCH=${GITHUB_REF##*/}
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Create Environment File
        id: environment-name
        run: |
          set -e
          if [ $BRANCH = release ]; then
            echo "Staging Configuration"
            echo "environment=staging" >> $GITHUB_OUTPUT
          elif [ $BRANCH = main ]; then
            echo "Production Configuration"
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "Wrong Branch"
            exit 0
          fi

  build:
    needs: [get-environment]
    name: Build ${{ needs.get-environment.outputs.environment-name }} Environment
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout the Code
        uses: actions/checkout@v4

      - name: Set Up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'adopt'
          java-version: '17'

      - name: Build API APP - JAR
        run: |
          ./mvnw clean package

      - name: Create Deployment Bundle
        run: |
          mkdir -p deployment/target
          cp -r codedeploy/* deployment/
          cp target/my-java-app-1.0-SNAPSHOT.jar deployment/target/
          zip -r deployment-$BUILD_NUMBER.zip deployment

      - name: Publish Deployment Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifact
          path: ${{github.workspace}}/deployment-${{ github.run_number }}.zip
